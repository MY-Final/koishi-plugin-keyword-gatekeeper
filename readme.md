# koishi-plugin-message-guard

[![npm](https://img.shields.io/npm/v/koishi-plugin-message-guard?style=flat-square)](https://www.npmjs.com/package/koishi-plugin-message-guard)

> 检测并撤回包含关键词的消息，进行禁言或踢出群聊，支持正则表达式匹配。

## 功能特点

- 🛡️ **关键词过滤**：自动检测消息中的敏感词汇
- 🔄 **正则表达式支持**：可使用正则表达式进行更灵活的匹配
- 🚫 **自动撤回**：检测到敏感内容时自动撤回消息
- ⏱️ **自动禁言**：可对发送敏感内容的用户进行禁言
- 📝 **自定义提示**：可自定义触发后的提示消息
- 🔢 **自动处罚机制**：根据用户触发次数自动升级处罚等级
- 🕒 **处罚记录重置**：支持定时重置用户的违规记录
- 🔍 **警告记录查询**：支持查询和管理用户的警告记录
- 🔐 **智能权限检查**：自动适应机器人权限状态，避免无效操作

## 安装方法

```bash
# 使用 npm
npm install koishi-plugin-message-guard

# 使用 yarn
yarn add koishi-plugin-message-guard

# 使用 Koishi 插件市场
# 在插件市场中搜索"message-guard"并安装
```

## 配置说明

```yaml
message-guard:
  # 关键词检测配置
  keywords:          # 需要检测的关键词列表
    - '敏感词1'
    - '敏感词2'
  useRegex: false    # 是否将关键词作为正则表达式处理
  regexFlags: 'i'    # 正则表达式标志（i-忽略大小写, g-全局匹配, m-多行匹配）

  # 基础处罚配置
  recall: true       # 是否撤回包含关键词的消息
  mute: true         # 是否禁言发送包含关键词消息的用户
  muteDuration: 600  # 禁言时长（秒）
  customMessage: '检测到违规内容，已进行处理'  # 检测到关键词后的提示消息

  # 自动处罚机制配置
  enableAutoPunishment: false    # 是否启用自动处罚机制
  secondViolationMuteDuration: 60  # 第二次违规的禁言时长（秒）
  maxViolationCount: 3           # 最大违规次数，达到此次数后将执行最终处罚
  kickOnMaxViolation: true       # 达到最大违规次数时是否踢出用户
  punishmentResetHours: 24       # 处罚记录重置时间（小时）
```

## 自动处罚机制

启用自动处罚机制后，插件会根据用户触发关键词的次数自动升级处罚等级：

1. **第一次触发**：警告提示并撤回消息
2. **第二次触发**：禁言指定时长（可自定义，默认60秒）
3. **第三次及以上触发**：
   - 如果未达到最大违规次数：禁言时间会随违规次数增加而递增
   - 如果达到最大违规次数：踢出群聊或长时间禁言（可配置）

系统会记录每个用户的触发次数，并支持按时间重置（默认24小时）。

## 权限检查

插件会智能检测机器人是否拥有管理员或群主权限，根据权限情况执行不同操作：

- **有管理权限**：正常执行禁言、踢人等管理操作，并发送相应的提示消息
- **无管理权限**：仅记录违规信息但不尝试执行需要管理权限的操作，也不发送任何提示消息

这样的设计使机器人在没有管理权限时表现得更像一个普通成员，避免发送无效的警告消息。同时，插件仍然会记录所有违规行为，以便在获得权限后能够执行相应的处罚。

## 警告记录管理

插件提供了一系列命令用于查询和管理用户的警告记录：

### 用户命令

- `keyword.warning.my` - 查询自己的警告记录
  ```
  > keyword.warning.my
  您当前的警告次数为: 1次，将在23小时45分钟后自动重置。
  最近一次触发: 关键词 "敏感词"
  触发时间: 2023/5/29 13:50:01
  执行处罚: 警告
  ```

### 管理员命令

以下命令需要管理员权限：

- `keyword.warning.query <userId>` - 查询指定用户的警告记录
  ```
  > keyword.warning.query 12345678
  用户 12345678 当前的警告次数为: 2次，将在5小时30分钟后自动重置。
  最近一次触发: 网址 "bad-example.com"
  触发时间: 2023/5/29 15:20:33
  执行处罚: 禁言
  触发消息: 大家快来看 bad-example.com 这个网站

  历史触发记录 (最近3条):
  1. 2023/5/28 10:15:22 - 关键词 "敏感词" (警告)
  2. 2023/5/29 08:45:10 - 关键词 "违禁词" (警告)
  3. 2023/5/29 15:20:33 - 网址 "bad-example.com" (禁言)
  ```

- `keyword.warning.reset <userId>` - 清零指定用户的警告记录
  ```
  > keyword.warning.reset 12345678
  已成功清零用户 12345678 的警告记录。
  ```

- `keyword.warning.list` - 列出所有有警告记录的用户
  ```
  > keyword.warning.list
  当前群组有警告记录的用户：
  用户 12345678: 2次警告，5小时30分钟后重置 (最近: 网址 "bad-example.com")
  用户 87654321: 1次警告，12小时15分钟后重置 (最近: 关键词 "敏感词")
  ```

- `keyword.warning.debug` - 查看所有警告记录的详细信息（调试用）
  ```
  > keyword.warning.debug
  当前所有警告记录:
  830160806:1150880493: 次数=1, 最后时间=2023/5/29 13:50:01
    最近触发: 敏感词 (keyword)
    处罚类型: warn
    消息内容: 这是一条包含敏感词的消息

  830160806:2233445566: 次数=2, 最后时间=2023/5/29 15:20:33
    最近触发: bad-example.com (url)
    处罚类型: mute
    消息内容: 大家快来看 bad-example.com 这个网站
  ...
  ```

- `keyword.warning.sync` - 强制同步所有警告记录
  ```
  > keyword.warning.sync
  警告记录同步完成，共处理了 8 条记录，其中保留 5 条，重置 3 条。
  ```

- `keyword.warning.clear-all` - 清空所有警告记录（需要超级管理员权限）
  ```
  > keyword.warning.clear-all
  已清理 12 条警告记录
  ```

## 数据持久化

从 v0.0.4 版本开始，警告记录会持久化存储在 Koishi 数据库中，不会因机器人重启而丢失。存储的数据包括：

- 用户ID和群组ID
- 违规次数和最后触发时间
- 触发的关键词或URL
- 触发类型（关键词/URL）
- 执行的处罚类型（警告/禁言/踢出）
- 触发的消息内容
- 处罚历史记录

这确保了即使机器人重启，也能保持完整的警告记录，并能提供详细的违规历史信息。

## 配置项

插件提供了以下配置选项：

## 适配器支持

该插件已在以下适配器上测试通过：
- OneBot (QQ机器人)

其他适配器可能需要额外配置或不完全支持所有功能。

## 使用示例

设置关键词列表并启用自动处罚机制：
```yaml
message-guard:
  keywords:
    - '敏感词1'
    - '[0-9]{11}'  # 匹配11位数字
  useRegex: true
  regexFlags: 'i'
  recall: true

  # 启用自动处罚机制
  enableAutoPunishment: true
  secondViolationMuteDuration: 120  # 第二次违规禁言2分钟
  maxViolationCount: 4              # 第四次违规执行最终处罚
  kickOnMaxViolation: true          # 达到最大违规次数时踢出用户
  punishmentResetHours: 24          # 24小时后重置违规记录
```

## 许可证

使用 [MIT](https://opensource.org/licenses/MIT) 许可证

## 版本更新

### v0.0.4
- 🔄 **持久化存储**：警告记录现在存储在数据库中，机器人重启后不会丢失
- 🛠️ **修复问题**：修复了执行处罚后无法查询到警告记录的问题
- 🔍 **增强命令**：新增 debug、sync 和 clear-all 命令，方便管理和查看警告记录
- 🏷️ **群组隔离**：改进了基于群组ID的记录隔离，确保不同群的记录互不影响

### v0.0.3
- 🌐 **URL检测**：增加了网址检测和过滤功能
- 🚨 **增强自动处罚**：完善了自动处罚机制
- 🔐 **更多管理命令**：增加了更多群组管理命令
