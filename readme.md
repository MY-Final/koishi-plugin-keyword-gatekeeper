# koishi-plugin-keyword-gatekeeper

[![npm](https://img.shields.io/npm/v/koishi-plugin-keyword-gatekeeper?style=flat-square)](https://www.npmjs.com/package/koishi-plugin-keyword-gatekeeper)

> 高级关键词过滤与自动处罚系统，支持关键词和URL检测、多级处罚机制、数据库持久化

## 🔰 插件说明

高级关键词守门员是一个功能全面的消息过滤与处罚系统，可以帮助群组管理员有效控制群内违规内容。

## 🌟 主要功能

- ✅ **关键词过滤**：自动检测群消息中的敏感词汇，支持正则表达式
- 🔗 **URL监控**：自动检测非白名单网址，防止垃圾链接和钓鱼网站
- 🚫 **多级处罚**：智能升级处罚等级，从警告到禁言再到踢出
- 📊 **记录系统**：持久化存储所有违规记录，重启不丢失数据
- 🔍 **查询功能**：支持查看完整历史记录，包含消息内容和处罚类型
- 👤 **艾特支持**：支持通过@用户执行查询和清零操作
- 🔐 **智能权限**：自动适应机器人权限状态，避免无效操作

## 📥 安装方法

```bash
# 使用 npm
npm install koishi-plugin-keyword-gatekeeper

# 使用 yarn
yarn add koishi-plugin-keyword-gatekeeper

# 使用 Koishi 插件市场
# 在插件市场中搜索"keyword-gatekeeper"并安装
```

## 📖 使用方法

1. 设置关键词列表，可选择启用正则表达式模式
2. 配置URL检测和白名单网址
3. 启用自动处罚机制，设置处罚升级规则
4. 使用相关命令管理用户的违规记录

## ⚙️ 配置说明

插件配置已分为5个功能区块，使设置更加直观：

### 关键词检测设置

```yaml
keyword-gatekeeper:
  # 关键词检测设置
  keywords:          # 需要检测的关键词列表
    - '敏感词1'
    - '敏感词2'
  useRegex: false    # 是否将关键词作为正则表达式处理
  regexFlags: 'i'    # 正则表达式标志（i-忽略大小写, g-全局匹配, m-多行匹配）
```

### 关键词处理设置

```yaml
  # 关键词处理设置
  recall: true       # 是否撤回包含关键词的消息
  mute: true         # 是否禁言发送包含关键词消息的用户
  muteDuration: 600  # 禁言时长（秒）
  customMessage: '检测到违规内容，已进行处理'  # 检测到关键词后的提示消息
```

### 网址检测设置

```yaml
  # 网址检测设置
  detectUrls: true   # 是否启用网址检测功能
  urlWhitelist:      # 网址白名单，这些域名不会被检测
    - 'koishi.chat'
    - 'github.com'
  urlAction: 'both'  # 检测到网址后的操作：recall(仅撤回)、mute(仅禁言)、both(撤回并禁言)
  urlMuteDuration: 300  # 检测到网址后的禁言时长（秒）
  urlCustomMessage: '检测到未经允许的网址链接，已进行处理'  # 检测到网址后的提示消息
```

### 自动处罚设置

```yaml
  # 自动处罚设置
  enableAutoPunishment: true    # 是否启用自动处罚机制
  secondViolationMuteDuration: 60  # 第二次违规的禁言时长（秒）
  maxViolationCount: 3           # 最大违规次数，达到此次数后将执行最终处罚
  kickOnMaxViolation: true       # 达到最大违规次数时是否踢出用户
  punishmentResetHours: 24       # 处罚记录重置时间（小时）
```

### 权限控制设置

```yaml
  # 权限控制设置
  allowUserSelfQuery: true       # 是否允许普通用户查询自己的警告记录
```

## 🚨 自动处罚机制

启用自动处罚机制后，插件会根据用户触发关键词的次数自动升级处罚等级：

1. **第一次触发**：警告提示并撤回消息
2. **第二次触发**：禁言指定时长（可自定义，默认60秒）
3. **第三次及以上触发**：
   - 如果未达到最大违规次数：禁言时间会随违规次数增加而递增
   - 如果达到最大违规次数：踢出群聊或长时间禁言（可配置）

系统会记录每个用户的触发次数，并支持按时间重置（默认24小时）。

## 👨‍💻 命令列表

### 用户命令

- `kw.warning.my` - 查询自己的警告记录
  ```
  > kw.warning.my
  您当前的警告次数为: 1次，将在23小时45分钟后自动重置。
  最近一次触发: 关键词 "敏感词"
  触发时间: 2023年05月29日 13时50分01秒
  执行处罚: 警告
  触发消息: 这是一条包含敏感词的消息

  历史触发记录 (最近2条):
  1. 2023年05月28日 10时15分22秒 - 关键词 "敏感词" (警告)
  2. 2023年05月28日 18时45分10秒 - 网址 "bad-example.com" (警告)
  ```

- `kw.warning.my-history` - 查看自己的完整警告历史
  ```
  > kw.warning.my-history
  您的完整警告历史记录 (共5条):
  1. 2023年05月28日 10时15分22秒 - 关键词 "敏感词" (警告)
     消息内容: 这是一条包含敏感词的消息
  2. 2023年05月28日 18时45分10秒 - 网址 "bad-example.com" (警告)
     消息内容: 大家快来看 bad-example.com 这个网站
  3. 2023年05月29日 09时30分45秒 - 关键词 "违禁词" (警告)
     消息内容: 这是一条包含违禁词的消息
  4. 2023年05月29日 12时20分33秒 - 关键词 "敏感词" (禁言)
     消息内容: 又是一条包含敏感词的消息
  5. 2023年05月29日 13时50分01秒 - 关键词 "敏感词" (禁言)
     消息内容: 这还是一条包含敏感词的消息
  ```

### 管理员命令

以下命令需要管理员权限：

- `kw.warning.query @用户` - 查询指定用户的警告记录
- `kw.warning.history @用户` - 查看指定用户的完整警告历史
- `kw.warning.reset @用户` - 清零指定用户的警告记录
- `kw.warning.list` - 列出所有有警告记录的用户
- `kw.warning.debug` - 查看所有警告记录的详细信息（调试用）
- `kw.warning.sync` - 强制同步所有警告记录
- `kw.warning.clear-all` - 清空所有警告记录（需要超级管理员权限）

## 💾 数据持久化

从 v0.0.4 版本开始，警告记录会持久化存储在 Koishi 数据库中，不会因机器人重启而丢失。存储的数据包括：

- 用户ID和群组ID
- 违规次数和最后触发时间
- 触发的关键词或URL
- 触发类型（关键词/URL）
- 执行的处罚类型（警告/禁言/踢出）
- 触发的消息内容（完整保存）
- 处罚历史记录（最多保留10条）
- 格式化的时间（方便阅读）

这确保了即使机器人重启，也能保持完整的警告记录，并能提供详细的违规历史信息。

## 🔌 适配器支持

该插件已在以下适配器上测试通过：
- OneBot (QQ机器人)

其他适配器可能需要额外配置或不完全支持所有功能。

## 📋 使用示例

设置关键词列表并启用自动处罚机制：
```yaml
keyword-gatekeeper:
  keywords:
    - '敏感词1'
    - '[0-9]{11}'  # 匹配11位数字
  useRegex: true
  regexFlags: 'i'
  recall: true

  # 启用自动处罚机制
  enableAutoPunishment: true
  secondViolationMuteDuration: 120  # 第二次违规禁言2分钟
  maxViolationCount: 4              # 第四次违规执行最终处罚
  kickOnMaxViolation: true          # 达到最大违规次数时踢出用户
  punishmentResetHours: 24          # 24小时后重置违规记录
```

## 📜 版本更新

### v0.0.5
- 🔄 **增强数据存储**：添加关键词、消息内容和处罚类型的完整记录
- 📊 **历史记录查询**：支持查看完整的历史违规记录，包含消息内容
- 📝 **命令输出优化**：改进命令输出格式，显示更详细的警告记录信息
- 🌐 **异步问题修复**：修复URL检测中的异步问题，提高检测稳定性
- 📉 **日志优化**：减少重复日志和不必要的信息日志，提高运行效率
- 🎨 **界面美化**：改进插件界面，将设置分组展示，更加直观易用
- 📚 **文档完善**：美化插件首页，增加emoji和详细使用说明

### v0.0.4
- 🔄 **持久化存储**：警告记录现在存储在数据库中，机器人重启后不会丢失
- 📊 **历史记录**：记录用户的违规历史，可查看完整的历史违规记录
- 📝 **消息存储**：保存触发违规的完整消息内容，方便管理员核实
- 👤 **艾特支持**：查询和清零命令支持通过@用户来指定目标
- 🔒 **权限控制**：可配置是否允许普通用户查询自己的警告记录
- 🛠️ **修复问题**：修复了计数错误和清空记录显示问题
- 🔍 **增强命令**：新增 history、my-history、debug、sync 和 clear-all 命令
- 🏷️ **群组隔离**：改进了基于群组ID的记录隔离，确保不同群的记录互不影响

### v0.0.3
- 🌐 **URL检测**：增加了网址检测和过滤功能
- 🚨 **增强自动处罚**：完善了自动处罚机制
- 🔐 **更多管理命令**：增加了更多群组管理命令

### v0.0.2
- 🔗 **URL检测**：添加URL检测功能，支持白名单
- 🚫 **多种处罚**：增加多种处罚方式：警告、禁言、踢出
- 🔄 **自动处罚**：添加自动处罚机制

### v0.0.1
- 🚀 **初始发布**：基本关键词检测功能
- 🗑️ **消息撤回**：简单的撤回操作
- ⏱️ **用户禁言**：基础禁言功能

## 📄 许可证

使用 [MIT](https://opensource.org/licenses/MIT) 许可证
